#cloud-config
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    passwd: $6$SP/vqykLkV9d05An$mJ/fEZ3gmfVvD1vwSJqxfjsK9z/bykIMbCZ/Hov.nt31e8h0XklDSE7ofw2YjPemVOSm14JdYoEfEzbxkFkY/1
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHDtJdQ12Q8pUUGM16V1Ko+es5LzuGT/0FGWWTmsKQxj madhankumaravelu93@gmail.com

chpasswd:
  list: |
    ubuntu:$6$SP/vqykLkV9d05An$mJ/fEZ3gmfVvD1vwSJqxfjsK9z/bykIMbCZ/Hov.nt31e8h0XklDSE7ofw2YjPemVOSm14JdYoEfEzbxkFkY/1
  expire: false

write_files:
  - path: /etc/modules-load.d/k8s.conf
    permissions: '0644'
    content: |
      overlay
      br_netfilter

  - path: /etc/netplan/99-custom.yaml
    permissions: '0600'
    content: |
      network:
        version: 2
        ethernets:
          ens18:
            dhcp4: true
            dhcp4-overrides:
              use-domains: true
            match:
              macaddress: ${mac_address}
            set-name: ens18
            nameservers:
              addresses: [8.8.8.8, 8.8.4.4]

  - path: /etc/sysctl.d/k8s.conf
    permissions: '0644'
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

  - path: /tmp/install-nix.sh
    content: |
      #!/bin/bash
      curl -L https://nixos.org/nix/install | sh -s -- --daemon --yes

runcmd:
  # Set hostname
  - hostnamectl set-hostname {hostname}

  # Basic system setup
  - modprobe overlay
  - modprobe br_netfilter
  - sysctl --system
  - systemctl restart systemd-timesyncd
  
  # Initial network setup and DNS
  - chmod 600 /etc/netplan/99-custom.yaml
  - netplan generate
  - netplan apply
  - sleep 10  # Wait for network to stabilize
  
  # Verify network connectivity before proceeding
  - |
    until ping -c 1 8.8.8.8 >/dev/null 2>&1; do
      echo "Waiting for network connectivity..."
      sleep 2
    done
  
  # Update and install basic packages
  - apt-get update
  - apt-get install -y apt-transport-https ca-certificates curl software-properties-common
  
  # Setup Kubernetes repository
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg
  - echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' > /etc/apt/sources.list.d/kubernetes.list
  
  # Install packages
  - apt-get update
  - |
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
      wget \
      vim \
      net-tools \
      qemu-guest-agent \
      kubelet \
      kubeadm \
      kubectl \
      containerd
  
  # Hold kubernetes packages
  - apt-mark hold kubelet kubeadm
  
  # Configure static IP (only if DHCP IP is available)
  - |
    if ip addr show ens18 | grep -q "inet "; then
      CURRENT_IP=$(ip addr show ens18 | grep "inet " | awk '{print $2}' | cut -d/ -f1)
      GATEWAY=$(ip route | grep default | awk '{print $3}')
      if [ ! -z "$CURRENT_IP" ] && [ ! -z "$GATEWAY" ]; then
        cat > /etc/netplan/99-custom.yaml << EOF
    network:
      version: 2
      ethernets:
        ens18:
          dhcp4: false
          match:
            macaddress: $(cat /sys/class/net/ens18/address)
          set-name: ens18
          addresses: 
            - $CURRENT_IP/24
          routes:
            - to: default
              via: $GATEWAY
          nameservers:
            addresses: [8.8.8.8, 8.8.4.4]
    EOF
        chmod 600 /etc/netplan/99-custom.yaml
        netplan generate
        netplan apply
      fi
    fi

  # Install Nix package manager
  - chmod +x /tmp/install-nix.sh
  - /tmp/install-nix.sh
  
  # Enable and start services
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - systemctl enable kubelet
  - systemctl start kubelet

  # Set bash as the default shell
  - chsh -s /bin/bash ubuntu

package_update: true
package_upgrade: true